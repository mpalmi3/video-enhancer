<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Enhancer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f0f;
            color: #e0e0e0;
            min-height: 100vh;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
        }

        .subtitle {
            color: #888;
            margin-bottom: 40px;
            font-size: 14px;
        }

        /* Steps */
        .step {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 20px;
            display: none;
        }

        .step.active { display: block; }

        .step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .step-number {
            background: #333;
            color: #aaa;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .step.active .step-number {
            background: #2563eb;
            color: #fff;
        }

        .step-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        /* Upload area */
        .drop-zone {
            border: 2px dashed #333;
            border-radius: 12px;
            padding: 60px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: #2563eb;
            background: rgba(37, 99, 235, 0.05);
        }

        .drop-zone-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .drop-zone-text {
            color: #888;
            font-size: 15px;
        }

        .drop-zone-text strong {
            color: #2563eb;
        }

        /* Progress bar */
        .progress-container {
            display: none;
            margin-top: 16px;
        }

        .progress-bar {
            height: 4px;
            background: #2a2a2a;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #2563eb;
            border-radius: 2px;
            transition: width 0.3s;
            width: 0%;
        }

        .progress-text {
            font-size: 13px;
            color: #888;
            margin-top: 8px;
        }

        /* Editor layout: video on left, segments on right */
        .editor-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .editor-video-col video {
            width: 100%;
            border-radius: 8px;
            background: #000;
        }

        .editor-video-col label,
        .editor-segments-col label {
            display: block;
            font-size: 13px;
            color: #888;
            margin-bottom: 8px;
            font-weight: 500;
        }

        /* Segment list */
        .segment-list {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            background: #111;
        }

        .segment-item {
            display: flex;
            gap: 10px;
            padding: 10px 12px;
            border-bottom: 1px solid #1e1e1e;
            transition: background 0.15s;
        }

        .segment-item:last-child {
            border-bottom: none;
        }

        .segment-item.active {
            background: rgba(37, 99, 235, 0.1);
        }

        .segment-timestamp {
            flex-shrink: 0;
            font-size: 12px;
            font-family: 'SF Mono', 'Consolas', monospace;
            color: #2563eb;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(37, 99, 235, 0.08);
            line-height: 1.6;
            user-select: none;
            white-space: nowrap;
            height: fit-content;
            margin-top: 2px;
        }

        .segment-timestamp:hover {
            background: rgba(37, 99, 235, 0.2);
        }

        .segment-text {
            flex: 1;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
            line-height: 1.6;
            padding: 4px 8px;
            font-family: inherit;
            resize: none;
            overflow: hidden;
        }

        .segment-text:focus {
            outline: none;
            border-color: #2563eb;
            background: rgba(37, 99, 235, 0.04);
        }

        /* Voice selector */
        .voice-section {
            margin-top: 24px;
        }

        .voice-section label {
            display: block;
            font-size: 13px;
            color: #888;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .voice-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .voice-option {
            background: #111;
            border: 2px solid #2a2a2a;
            border-radius: 8px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.15s;
            text-align: center;
        }

        .voice-option:hover {
            border-color: #444;
        }

        .voice-option.selected {
            border-color: #2563eb;
            background: rgba(37, 99, 235, 0.08);
        }

        .voice-name {
            font-weight: 600;
            font-size: 14px;
            color: #fff;
            text-transform: capitalize;
        }

        .voice-desc {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .btn-primary {
            background: #2563eb;
            color: #fff;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-primary:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #222;
            color: #e0e0e0;
            border: 1px solid #333;
        }

        .btn-secondary:hover {
            background: #2a2a2a;
        }

        .actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        /* Preview */
        .preview-section {
            margin-top: 20px;
        }

        .preview-section video {
            width: 100%;
            border-radius: 8px;
            background: #000;
        }

        /* Spinner */
        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(255,255,255,0.2);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Status message */
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px;
            background: #111;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 14px;
            color: #aaa;
        }

        .status.error {
            background: rgba(220, 38, 38, 0.1);
            color: #f87171;
            border: 1px solid rgba(220, 38, 38, 0.2);
        }

        /* File info */
        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: #111;
            border-radius: 8px;
            margin-top: 12px;
        }

        .file-info-icon {
            font-size: 24px;
            opacity: 0.6;
        }

        .file-info-name {
            font-size: 14px;
            color: #fff;
            font-weight: 500;
        }

        .file-info-size {
            font-size: 12px;
            color: #666;
        }

        @media (max-width: 768px) {
            .editor-layout { grid-template-columns: 1fr; }
            .voice-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Video Enhancer</h1>
        <p class="subtitle">Upload a video, clean up the narration, re-voice with AI, and add captions.</p>

        <!-- Step 1: Upload -->
        <div class="step active" id="step-upload">
            <div class="step-header">
                <div class="step-number">1</div>
                <div class="step-title">Upload Video</div>
            </div>

            <div class="drop-zone" id="drop-zone">
                <div class="drop-zone-icon">&#127916;</div>
                <div class="drop-zone-text">
                    Drag & drop your video here or <strong>click to browse</strong>
                </div>
            </div>
            <input type="file" id="file-input" accept="video/*" hidden>

            <div class="file-info" id="file-info" style="display:none">
                <div class="file-info-icon">&#128196;</div>
                <div>
                    <div class="file-info-name" id="file-name"></div>
                    <div class="file-info-size" id="file-size"></div>
                </div>
            </div>

            <div class="progress-container" id="upload-progress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-text" id="progress-text">Uploading...</div>
            </div>
        </div>

        <!-- Step 2: Transcribe & Edit -->
        <div class="step" id="step-transcribe">
            <div class="step-header">
                <div class="step-number">2</div>
                <div class="step-title">Edit Script</div>
            </div>

            <div class="editor-layout">
                <div class="editor-video-col">
                    <label>Original Video</label>
                    <video id="original-video" controls></video>
                </div>
                <div class="editor-segments-col">
                    <label>Script â€” click a timestamp to jump in the video</label>
                    <div class="segment-list" id="segment-list"></div>
                </div>
            </div>

            <div class="voice-section">
                <label>Select Voice</label>
                <div class="voice-grid" id="voice-grid"></div>
            </div>

            <div class="actions">
                <button class="btn btn-primary" id="btn-generate">Generate Video</button>
            </div>

            <div class="status" id="generate-status" style="display:none">
                <div class="spinner"></div>
                <span id="generate-status-text">Generating...</span>
            </div>
        </div>

        <!-- Step 3: Preview & Download -->
        <div class="step" id="step-preview">
            <div class="step-header">
                <div class="step-number">3</div>
                <div class="step-title">Preview & Download</div>
            </div>

            <div class="preview-section">
                <video id="preview-video" controls></video>
            </div>

            <div class="actions">
                <button class="btn btn-primary" id="btn-download">Download Video</button>
                <button class="btn btn-secondary" id="btn-start-over">Start Over</button>
            </div>
        </div>
    </div>

    <script>
        const voiceDescriptions = {
            alloy: 'Neutral & balanced',
            echo: 'Warm & smooth',
            fable: 'Expressive & British',
            onyx: 'Deep & authoritative',
            nova: 'Friendly & upbeat',
            shimmer: 'Clear & gentle',
        };

        let jobId = null;
        let segments = [];
        let selectedVoice = 'nova';

        // --- DOM refs ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileInfo = document.getElementById('file-info');
        const fileName = document.getElementById('file-name');
        const fileSize = document.getElementById('file-size');
        const uploadProgress = document.getElementById('upload-progress');
        const progressFill = document.getElementById('progress-fill');
        const progressText = document.getElementById('progress-text');

        const stepUpload = document.getElementById('step-upload');
        const stepTranscribe = document.getElementById('step-transcribe');
        const stepPreview = document.getElementById('step-preview');

        const originalVideo = document.getElementById('original-video');
        const segmentList = document.getElementById('segment-list');
        const voiceGrid = document.getElementById('voice-grid');
        const btnGenerate = document.getElementById('btn-generate');
        const generateStatus = document.getElementById('generate-status');
        const generateStatusText = document.getElementById('generate-status-text');

        const previewVideo = document.getElementById('preview-video');
        const btnDownload = document.getElementById('btn-download');
        const btnStartOver = document.getElementById('btn-start-over');

        // --- Voice grid ---
        Object.entries(voiceDescriptions).forEach(([voice, desc]) => {
            const div = document.createElement('div');
            div.className = 'voice-option' + (voice === selectedVoice ? ' selected' : '');
            div.innerHTML = `<div class="voice-name">${voice}</div><div class="voice-desc">${desc}</div>`;
            div.addEventListener('click', () => {
                document.querySelectorAll('.voice-option').forEach(el => el.classList.remove('selected'));
                div.classList.add('selected');
                selectedVoice = voice;
            });
            voiceGrid.appendChild(div);
        });

        // --- Timestamp formatting ---
        function formatTimestamp(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
        }

        // --- Build segment editor ---
        function renderSegments(segs) {
            segmentList.innerHTML = '';
            segs.forEach((seg, i) => {
                const row = document.createElement('div');
                row.className = 'segment-item';
                row.dataset.index = i;

                const ts = document.createElement('div');
                ts.className = 'segment-timestamp';
                ts.textContent = formatTimestamp(seg.start);
                ts.title = `Jump to ${formatTimestamp(seg.start)}`;
                ts.addEventListener('click', () => {
                    originalVideo.currentTime = seg.start;
                    originalVideo.play();
                });

                const textarea = document.createElement('textarea');
                textarea.className = 'segment-text';
                textarea.value = seg.text;
                textarea.rows = 1;
                textarea.addEventListener('input', () => {
                    // Auto-resize
                    textarea.style.height = 'auto';
                    textarea.style.height = textarea.scrollHeight + 'px';
                    // Update segment data
                    segments[i].text = textarea.value;
                });
                textarea.addEventListener('focus', () => {
                    originalVideo.currentTime = seg.start;
                });

                row.appendChild(ts);
                row.appendChild(textarea);
                segmentList.appendChild(row);

                // Auto-resize on initial render
                requestAnimationFrame(() => {
                    textarea.style.height = 'auto';
                    textarea.style.height = textarea.scrollHeight + 'px';
                });
            });
        }

        // --- Highlight active segment during video playback ---
        originalVideo.addEventListener('timeupdate', () => {
            const t = originalVideo.currentTime;
            document.querySelectorAll('.segment-item').forEach(row => {
                const i = parseInt(row.dataset.index);
                const seg = segments[i];
                if (seg && t >= seg.start && t < seg.end) {
                    if (!row.classList.contains('active')) {
                        row.classList.add('active');
                        // Scroll into view if needed
                        row.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                    }
                } else {
                    row.classList.remove('active');
                }
            });
        });

        // --- Upload ---
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                handleFile(fileInput.files[0]);
            }
        });

        function formatSize(bytes) {
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        async function handleFile(file) {
            fileName.textContent = file.name;
            fileSize.textContent = formatSize(file.size);
            fileInfo.style.display = 'flex';

            uploadProgress.style.display = 'block';
            progressText.textContent = 'Uploading...';
            progressFill.style.width = '0%';

            const formData = new FormData();
            formData.append('file', file);

            try {
                const xhr = new XMLHttpRequest();
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const pct = Math.round((e.loaded / e.total) * 100);
                        progressFill.style.width = pct + '%';
                        progressText.textContent = `Uploading... ${pct}%`;
                    }
                });

                const uploadResult = await new Promise((resolve, reject) => {
                    xhr.onload = () => {
                        if (xhr.status === 200) resolve(JSON.parse(xhr.responseText));
                        else reject(new Error(xhr.responseText));
                    };
                    xhr.onerror = () => reject(new Error('Upload failed'));
                    xhr.open('POST', '/upload');
                    xhr.send(formData);
                });

                jobId = uploadResult.job_id;
                progressText.textContent = 'Transcribing and cleaning up script...';
                progressFill.style.width = '100%';

                const transcribeRes = await fetch(`/transcribe/${jobId}`, { method: 'POST' });
                if (!transcribeRes.ok) {
                    const err = await transcribeRes.json();
                    throw new Error(err.detail || 'Transcription failed');
                }
                const data = await transcribeRes.json();

                segments = data.segments;

                // Set up video player with original video
                originalVideo.src = `/original/${jobId}`;

                // Render segment editor
                renderSegments(segments);

                // Move to step 2
                stepUpload.classList.remove('active');
                stepTranscribe.classList.add('active');

            } catch (err) {
                progressText.textContent = 'Error: ' + err.message;
                progressFill.style.background = '#dc2626';
            }
        }

        // --- Generate ---
        btnGenerate.addEventListener('click', async () => {
            btnGenerate.disabled = true;
            generateStatus.style.display = 'flex';
            generateStatus.classList.remove('error');
            generateStatusText.textContent = 'Generating voiceover, captions, and final video... This may take a few minutes.';

            try {
                // Collect edited text from segment textareas
                const editedSegments = segments.map(s => ({...s}));
                const fullScript = editedSegments.map(s => s.text).join(' ');

                const res = await fetch(`/generate/${jobId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        script: fullScript,
                        segments: editedSegments,
                        voice: selectedVoice,
                    }),
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Generation failed');
                }

                previewVideo.src = `/preview/${jobId}`;
                stepTranscribe.classList.remove('active');
                stepPreview.classList.add('active');

            } catch (err) {
                generateStatus.classList.add('error');
                generateStatusText.textContent = 'Error: ' + err.message;
            } finally {
                btnGenerate.disabled = false;
            }
        });

        // --- Download ---
        btnDownload.addEventListener('click', () => {
            window.location.href = `/download/${jobId}`;
        });

        btnStartOver.addEventListener('click', () => {
            jobId = null;
            segments = [];
            fileInput.value = '';
            fileInfo.style.display = 'none';
            uploadProgress.style.display = 'none';
            progressFill.style.width = '0%';
            progressFill.style.background = '#2563eb';
            generateStatus.style.display = 'none';
            originalVideo.src = '';
            previewVideo.src = '';
            segmentList.innerHTML = '';
            stepPreview.classList.remove('active');
            stepUpload.classList.add('active');
        });
    </script>
</body>
</html>
